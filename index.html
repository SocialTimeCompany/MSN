<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intersol Messenger Grupal</title>
    <style>
        /* (Mismos estilos anteriores + Estilos de Grupos) */
        body { background: #e3efff; font-family: 'Tahoma', sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .msn-main { width: 320px; height: 580px; background: white; border: 2px solid #0055e0; border-radius: 8px; display: flex; flex-direction: column; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .header { background: linear-gradient(#0055e0, #4090ff); color: white; padding: 10px; font-weight: bold; font-size: 13px; display: flex; justify-content: space-between; }
        .user-card { background: #f0f0f0; padding: 12px; border-bottom: 1px solid #ccc; display: flex; align-items: center; gap: 10px; }
        .avatar { width: 45px; height: 45px; background: #0078d4; border: 2px solid white; border-radius: 4px; background-size: cover; cursor: pointer; }
        .tabs { display: flex; background: #eee; border-bottom: 1px solid #ccc; }
        .tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; font-size: 12px; font-weight: bold; }
        .tab.active { background: white; border-bottom: 2px solid #0055e0; }
        .list-container { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .item { display: flex; align-items: center; padding: 8px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
        .item:hover { background: #e1eefc; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        
        #chat-window { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; flex-direction: column; z-index: 100; }
        #chat-msgs { flex-grow: 1; background: white; margin: 10px; padding: 10px; overflow-y: auto; border: 1px solid #ccc; font-size: 13px; white-space: pre-wrap; }
        .toolbar { padding: 5px 10px; display: flex; gap: 10px; background: #eee; }
        .chat-input-area { padding: 10px; display: flex; gap: 5px; }
        input { padding: 8px; border: 1px solid #ccc; }
        
        .btn-crear { position: absolute; bottom: 15px; right: 15px; background: #31a24c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

<audio id="nudge-sound" src="https://www.myinstants.com/media/sounds/msn-nudge.mp3"></audio>

<div class="msn-main" id="main-win">
    <div class="header"><span>Intersol Messenger</span></div>
    
    <div class="user-card">
        <div class="avatar" id="my-avatar"></div>
        <div>
            <b id="my-name">Usuario</b><br>
            <select id="status-select" onchange="actualizarEstado()" style="font-size:10px;">
                <option value="online">üü¢ Conectado</option>
                <option value="busy">üî¥ Ocupado</option>
            </select>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="cambiarTab('contactos')">Contactos</div>
        <div class="tab" onclick="cambiarTab('grupos')">Grupos</div>
    </div>

    <div class="list-container" id="main-list"></div>
    <button class="btn-crear" id="btn-add" onclick="crearGrupo()">+</button>
</div>

<div id="chat-window">
    <div class="header">
        <span id="chat-title">Chat</span>
        <span onclick="cerrarChat()" style="cursor:pointer">X</span>
    </div>
    <div id="chat-msgs"></div>
    <div class="toolbar">
        <button onclick="enviarZumbido()">üîî</button>
        <button onclick="dibujarCarita()">üé®</button>
        <button onclick="lanzarTrivia()">‚ùì</button>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" style="flex-grow:1">
        <button onclick="enviarMensaje()">Enviar</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWMmRpC9chHuBMWbMCRFeEzhQjh1dJ0Uw",
        databaseURL: "https://intersol-ce061-default-rtdb.firebaseio.com",
        projectId: "intersol-ce061",
        appId: "1:582674758781:web:aa6326c6d84b675c504514"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const session = JSON.parse(localStorage.getItem('intersol_user'));
    
    let vistaActual = 'contactos';
    let chatActivo = null;
    let esChatGrupal = false;

    // --- CAMBIAR ENTRE CONTACTOS Y GRUPOS ---
    window.cambiarTab = (tab) => {
        vistaActual = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('btn-add').style.display = tab === 'grupos' ? 'block' : 'none';
        renderizarLista();
    };

    function renderizarLista() {
        const list = document.getElementById('main-list');
        list.innerHTML = "";
        
        const path = vistaActual === 'contactos' ? 'intersol/usuarios' : 'intersol/grupos';
        
        onValue(ref(db, path), (snap) => {
            list.innerHTML = "";
            snap.forEach(item => {
                const data = item.val();
                if(vistaActual === 'contactos' && data.email === session.email) return;

                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = vistaActual === 'contactos' 
                    ? `<span class="status-dot ${data.estado || 'online'}"></span> <b>${data.nombre}</b>`
                    : `üë• <b>${data.nombre}</b>`;
                
                div.onclick = () => abrirChat(data, vistaActual === 'grupos');
                list.appendChild(div);
            });
        }, { onlyOnce: true });
    }

    window.crearGrupo = () => {
        const nom = prompt("Nombre del nuevo grupo:");
        if(nom) push(ref(db, 'intersol/grupos'), { nombre: nom, creadoPor: session.email });
        renderizarLista();
    };

    window.abrirChat = (target, esGrupo) => {
        chatActivo = target;
        esChatGrupal = esGrupo;
        document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('chat-title').innerText = esGrupo ? "Grupo: " + target.nombre : target.nombre;
        cargarMensajes();
    };

    function cargarMensajes() {
        // Si es grupo, el ID es el nombre del grupo. Si es persona, es el combinado de emails.
        const chatId = esChatGrupal 
            ? chatActivo.nombre.replace(/\s/g, '_') 
            : [session.email, chatActivo.email].sort().join('_').replace(/\./g, '_');

        onValue(ref(db, `intersol/chats/${chatId}`), (snap) => {
            const box = document.getElementById('chat-msgs');
            box.innerHTML = "";
            snap.forEach(m => {
                const msg = m.val();
                box.innerHTML += `<div><b style="color:#0055e0">${msg.user}:</b> ${msg.text || 'üîî Zumbido'}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.enviarMensaje = (txt = null) => {
        const input = document.getElementById('chat-input');
        const finalTxt = txt || input.value;
        if(!finalTxt || !chatActivo) return;

        const chatId = esChatGrupal 
            ? chatActivo.nombre.replace(/\s/g, '_') 
            : [session.email, chatActivo.email].sort().join('_').replace(/\./g, '_');

        push(ref(db, `intersol/chats/${chatId}`), {
            user: session.nombre,
            text: finalTxt,
            time: serverTimestamp()
        });
        input.value = "";
    };

    window.enviarZumbido = () => enviarMensaje("¬°HA ENVIADO UN ZUMBIDO!");
    window.dibujarCarita = () => enviarMensaje(" (‚Ä¢_‚Ä¢) \n <)   )‚ïØ \n  /    \\ ");
    window.lanzarTrivia = () => enviarMensaje("ü§ñ TRIVIA: ¬øCu√°l es el lenguaje de esta app?");
    window.cerrarChat = () => document.getElementById('chat-window').style.display='none';

    // Inicio
    renderizarLista();
</script>
</body>
</html>
